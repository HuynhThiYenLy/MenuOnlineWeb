<!DOCTYPE html>
<html lang="vi">

<head>
    <!-- Các thẻ meta cần thiết -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Regal Admin</title>
    <!-- Các file CSS -->
    <link rel="stylesheet" href="../../vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="../../vendors/feather/feather.css">
    <link rel="stylesheet" href="../../vendors/base/vendor.bundle.base.css">
    <link rel="stylesheet" href="../../css/style.css">
    <!-- Favicon -->
    <link rel="shortcut icon" href="../../images/favicon.png" />
</head>

<body>
    <!-- Nội dung trang web -->
    <div class="container-scroller">
        <!-- Navbar -->
        <nav class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
            <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center">
                <a class="navbar-brand brand-logo" href="../../index.html"><img src="../../images/logo.svg"
                        alt="logo" /></a>
                <a class="navbar-brand brand-logo-mini" href="../../index.html"><img src="../../images/logo-mini.svg"
                        alt="logo" /></a>
            </div>
            <div class="navbar-menu-wrapper d-flex align-items-center justify-content-end">
                <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
                    <span class="icon-menu"></span>
                </button>
                <ul class="navbar-nav mr-lg-2">
                    <li class="nav-item nav-search d-none d-lg-block">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="search">
                                    <i class="icon-search"></i>
                                </span>
                            </div>
                            <input type="text" class="form-control" placeholder="Tìm kiếm dự án.." aria-label="search"
                                aria-describedby="search">
                        </div>
                    </li>
                </ul>
                <ul class="navbar-nav navbar-nav-right">
                    <li class="nav-item dropdown d-lg-flex d-none">
                        <button type="button" class="btn btn-info font-weight-bold">+ Tạo mới</button>
                    </li>
                    <li class="nav-item dropdown d-flex">
                        <a class="nav-link count-indicator dropdown-toggle d-flex justify-content-center align-items-center"
                            id="messageDropdown" href="#" data-toggle="dropdown">
                            <i class="icon-air-play mx-0"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list"
                            aria-labelledby="messageDropdown">
                            <p class="mb-0 font-weight-normal float-left dropdown-header">Tin nhắn</p>
                            <a class="dropdown-item preview-item">
                                <div class="preview-thumbnail">
                                    <img src="../../images/faces/face4.jpg" alt="image" class="profile-pic">
                                </div>
                                <div class="preview-item-content flex-grow">
                                    <h6 class="preview-subject ellipsis font-weight-normal">David Grey
                                    </h6>
                                    <p class="font-weight-light small-text text-muted mb-0">
                                        Cuộc họp đã bị hủy
                                    </p>
                                </div>
                            </a>
                            <a class="dropdown-item preview-item">
                                <div class="preview-thumbnail">
                                    <img src="../../images/faces/face2.jpg" alt="image" class="profile-pic">
                                </div>
                                <div class="preview-item-content flex-grow">
                                    <h6 class="preview-subject ellipsis font-weight-normal">Tim Cook
                                    </h6>
                                    <p class="font-weight-light small-text text-muted mb-0">
                                        Ra mắt sản phẩm mới
                                    </p>
                                </div>
                            </a>
                            <a class="dropdown-item preview-item">
                                <div class="preview-thumbnail">
                                    <img src="../../images/faces/face3.jpg" alt="image" class="profile-pic">
                                </div>
                                <div class="preview-item-content flex-grow">
                                    <h6 class="preview-subject ellipsis font-weight-normal"> Johnson
                                    </h6>
                                    <p class="font-weight-light small-text text-muted mb-0">
                                        Cuộc họp hội đồng sắp tới
                                    </p>
                                </div>
                            </a>
                        </div>
                    </li>
                    <li class="nav-item dropdown d-flex mr-4 ">
                        <a class="nav-link count-indicator dropdown-toggle d-flex align-items-center justify-content-center"
                            id="notificationDropdown" href="#" data-toggle="dropdown">
                            <i class="icon-cog"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list"
                            aria-labelledby="notificationDropdown">
                            <p class="mb-0 font-weight-normal float-left dropdown-header">Cài đặt</p>
                            <a class="dropdown-item preview-item">
                                <i class="icon-head"></i> Hồ sơ
                            </a>
                            <a class="dropdown-item preview-item">
                                <i class="icon-inbox"></i> Đăng xuất
                            </a>
                        </div>
                    </li>
                    <li class="nav-item dropdown mr-4 d-lg-flex d-none">
                        <a class="nav-link count-indicatord-flex align-item s-center justify-content-center" href="#">
                            <i class="icon-grid"></i>
                        </a>
                    </li>
                </ul>
                <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button"
                    data-toggle="offcanvas">
                    <span class="icon-menu"></span>
                </button>
            </div>
        </nav>

        <!-- Sidebar và nội dung chính -->
        <div class="container-fluid page-body-wrapper">
            <!-- Sidebar -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
                <div class="user-profile">
                    <div class="user-image">
                        <img src="../../images/faces/face28.png">
                    </div>
                    <div class="user-name">
                        Edward Spencer
                    </div>
                    <div class="user-designation">
                        Developer
                    </div>
                </div>
                <ul class="nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../../index.html">
                            <i class="icon-box menu-icon"></i>
                            <span class="menu-title">Bảng điều khiển</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="collapse" href="#ui-basic" aria-expanded="false"
                            aria-controls="ui-basic">
                            <i class="icon-disc menu-icon"></i>
                            <span class="menu-title">Danh mục</span>
                            <i class="menu-arrow"></i>
                        </a>
                        <div class="collapse" id="ui-basic">
                            <ul class="nav flex-column sub-menu">
                                <li class="nav-item"> <a class="nav-link"
                                        href="../../pages/ui-features/typography.html">Danh mục</a>
                                </li>
                                <li class="nav-item"> <a class="nav-link"
                                        href="../../pages/ui-features/addCategory.html">Thêm danh mục</a></li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="collapse" href="#ui-advanced" aria-expanded="false"
                            aria-controls="ui-advanced">
                            <i class="icon-disc menu-icon"></i>
                            <span class="menu-title">Sản phẩm</span>
                            <i class="menu-arrow"></i>
                        </a>
                        <div class="collapse" id="ui-advanced">
                            <ul class="nav flex-column sub-menu">
                                <li class="nav-item"> <a class="nav-link"
                                        href="../../pages/ui-features/products.html">Sản phẩm</a>
                                </li>
                                <li class="nav-item"> <a class="nav-link"
                                        href="../../pages/ui-features/addProduct.html">Thêm sản phẩm</a></li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item"> <a class="nav-link" href="../../pages/ui-features/buttons.html">Người dùng</a>
                    </li>
                    <li class="nav-item"> <a class="nav-link" href="../../pages/ui-features/bill.html">Hóa đơn</a>
                    </li>
                </ul>
            </nav>

            <!-- Form sửa sản phẩm -->
            <div class="card" style="flex: 1;">
                <div class="card-body">
                    <form class="forms-sample" id="updateProductForm" action="#" method="PUT">
                        <input type="hidden" id="productID" name="productID" value="">
                        <div class="form-group">
                            <label for="productName">Tên sản phẩm</label>
                            <input type="text" class="form-control" id="productName" name="productName"
                                placeholder="Nhập tên sản phẩm">
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Giá</label>
                            <input type="text" class="form-control" id="productPrice" name="productPrice"
                                placeholder="Nhập giá">
                        </div>
                        <div class="form-group">
                            <label for="productSize">Kích thước</label>
                            <input type="text" class="form-control" id="productSize" name="productSize"
                                placeholder="Nhập kích thước">
                        </div>
                        <div class="form-group">
                            <label for="productXuatXu">Xuất xứ</label>
                            <input type="text" class="form-control" id="productXuatXu" name="productXuatXu"
                                placeholder="Nhập xuất xứ">
                        </div>
                        <div class="form-group">
                            <label for="productTinhTrang">Tình trạng</label>
                            <input type="text" class="form-control" id="productTinhTrang" name="productTinhTrang"
                                placeholder="Nhập tình trạng">
                        </div>
                        <div class="form-group">
                            <label for="productImage">File ảnh</label>
                            <input type="text" class="form-control" id="productImg" name="productImg"
                                placeholder="Nhập link ảnh">
                        </div>
                        <div class="form-group">
                            <label for="parentCategory">Danh mục cha</label>
                            <select class="form-control" id="parentCategory" name="parentCategory">
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="subCategory">Danh mục con</label>
                            <select class="form-control" id="subCategory" name="subCategory" disabled>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary me-2">Gửi</button>
                        <button type="button" class="btn btn-light" onclick="cancel()">Hủy</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript dependencies -->
    <script src="../../vendors/base/vendor.bundle.base.js"></script>
    <script src="../../js/off-canvas.js"></script>
    <script src="../../js/hoverable-collapse.js"></script>
    <script src="../../js/template.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);  // truy cập, thêm, hoặc loại bỏ tham số dc truyền URL
            const productID = urlParams.get('id'); // lấy giá trị tham số có tên id
            
            const apiUrl = "http://localhost:3000/product/view/" + productID; 
            
            fetch(apiUrl)
                .then(response => {
                    return response.json();
                })
                .then(product => {
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productPrice').value = product.gia;
                    document.getElementById('productSize').value = product.kichCo;
                    document.getElementById('productXuatXu').value = product.xuatXu;
                    document.getElementById('productTinhTrang').value = product.tinhTrang;
                    document.getElementById('productImg').value = product.img;
                    document.getElementById('productID').value = productID;
                })
                .catch(error => console.error("Error:", error));

            var str = "";
            // Lấy danh sách danh mục cha từ API và điền vào spinner danh mục cha
            fetch("http://192.168.211.1:3000/category/getparent")
                .then(response => response.json())
                .then(data => {
                    str = `<option value="">Chọn danh mục</option>`;
                    data.forEach(item => {
                        str += `<option value="${item._id}">${item.name}</option>`;
                    })
                    document.getElementById("parentCategory").innerHTML = str;
                })
                .catch(error => {
                    console.error("Error:", error);
                });

            // Lắng nghe sự kiện thay đổi trong spinner danh mục cha và tải danh mục con tương ứng
            document.getElementById("parentCategory").addEventListener('change', (event) => {
                const parentID = event.target.value;

                fetch(`http://192.168.211.1:3000/category/getparent/${parentID}`)
                    .then(response => {
                        return response.json();
                    })
                    .then(data => {
                        str = `<option value="">Chọn loại sp</option>`;
                        data.forEach(item => {
                            str += `<option value="${item._id}">${item.name}</option>`;
                        })
                        document.getElementById("subCategory").innerHTML = str;
                        document.getElementById("subCategory").removeAttribute("disabled");
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
            });
        });

        document.getElementById("updateProductForm").addEventListener("submit", async function (event) {
            event.preventDefault();

            const productID = document.getElementById('productID').value; 
            const name = document.getElementById('productName').value; 
            const gia = document.getElementById('productPrice').value;
            const img = document.getElementById('productImg').value;
            const kichCo = document.getElementById('productSize').value; 
            const xuatXu = document.getElementById('productXuatXu').value; 
            const tinhTrang = document.getElementById('productTinhTrang').value; 
            const categoryID = document.getElementById('subCategory').value; 


            if (!productID) {
                console.error('Không tìm thấy ID sản phẩm');
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/product/update/${productID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(
                        {
                            name: name,
                            gia: gia,
                            img: img,
                            kichCo: kichCo,
                            xuatXu: xuatXu,
                            tinhTrang: tinhTrang,
                            categoryID: categoryID
                        }
                    )
                });
                const data = await response.json();
                // Xử lý phản hồi từ server nếu cần
                if (response.status == 200) {
                    alert('Sản phẩm đã được cập nhật thành công.'); 
                    window.location.href = `./products.html`;
                } else {
                    console.error('Lỗi khi cập nhật sản phẩm');
                }
            } catch (error) {
                console.error("Error:", error);
            }
        });

        function cancel() {
            window.history.back();
        }
    </script>




</body>

</html>